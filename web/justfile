# Guitar Tone Shootout - Web Frontend Tasks
# Run from web/ directory

default:
    @just --list

# ============================================
# Setup
# ============================================

# Setup development environment (Python + Node)
setup: setup-python setup-node
    @echo "✓ Web setup complete"

# Setup Python environment
setup-python:
    @[ -d .venv ] || uv venv
    uv pip install -e ".[dev]"

# Setup Node environment (pnpm + Tailwind + Flowbite)
setup-node:
    pnpm install
    @echo "✓ Node dependencies installed"

# ============================================
# Build
# ============================================

# Build all frontend assets
build:
    pnpm build
    @echo "✓ Frontend assets built"

# Build CSS with Tailwind
build-css:
    pnpm build:css

# Build JS with esbuild
build-js:
    pnpm build:js

# ============================================
# Development
# ============================================

# Watch CSS for changes (run in separate terminal)
watch-css:
    pnpm dev:css

# Run Flask development server
serve:
    uv run python -m app.main

# Run Flask with auto-reload
serve-dev:
    FLASK_DEBUG=1 uv run flask --app app.main:app run --reload --port 5000

# Development mode: watch CSS + Flask (requires two terminals)
dev:
    @echo "Run these in separate terminals:"
    @echo "  just watch-css"
    @echo "  just serve-dev"
    @echo ""
    @echo "Or use: pnpm dev (watches CSS only)"

# ============================================
# Code Quality
# ============================================

# Run linter
lint:
    uv run ruff check app tests

# Run linter with auto-fix
lint-fix:
    uv run ruff check --fix app tests

# Format code
format:
    uv run ruff format app tests

# Check formatting
format-check:
    uv run ruff format --check app tests

# Run type checker
typecheck:
    uv run mypy app tests

# Run tests
test:
    uv run pytest

# Run tests with coverage
test-cov:
    uv run pytest --cov=app --cov-report=term-missing

# Run all checks
check: lint format-check typecheck test
    @echo "✓ All web checks passed"

# ============================================
# Production
# ============================================

# Build for production
build-prod: build
    @echo "✓ Production build complete"

# Run production server with gunicorn
serve-prod:
    uv run gunicorn "app:create_app()" --bind 0.0.0.0:8000 --workers 4

# ============================================
# Utilities
# ============================================

# Clean build artifacts
clean:
    rm -rf node_modules
    rm -rf static/dist/*.css static/dist/*.js
    rm -rf .pytest_cache .mypy_cache .ruff_cache
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    @echo "✓ Cleaned"

# Update Node dependencies
update-deps:
    pnpm update
    @echo "✓ Dependencies updated"
