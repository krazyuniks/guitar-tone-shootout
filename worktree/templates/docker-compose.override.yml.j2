# docker-compose.override.yml
# Auto-generated by worktree.py - DO NOT EDIT MANUALLY
# Worktree: {{ worktree.worktree_name }}
# Branch: {{ worktree.branch }}
# Generated: {{ generated_at }}
#
# This file overrides docker-compose.yml with worktree-specific ports and volumes.
# The shared model cache volume ({{ settings.shared_model_cache_volume }}) is mounted read-only.

services:
  backend:
    container_name: {{ worktree.compose_project }}-backend
    ports:
      - "127.0.0.1:{{ worktree.ports.backend }}:8000"
    volumes:
      - ./backend:/app
      - ./pipeline:/pipeline:ro
      - {{ settings.shared_model_cache_volume }}:/data/models/cache:ro
      - {{ worktree.volumes.uploads }}:/data/uploads
    environment:
      - PUBLIC_API_URL=http://localhost:{{ worktree.ports.backend }}

  frontend:
    container_name: {{ worktree.compose_project }}-frontend
    ports:
      - "127.0.0.1:{{ worktree.ports.frontend }}:4321"
    environment:
      - PUBLIC_API_URL=http://localhost:{{ worktree.ports.backend }}

  worker:
    container_name: {{ worktree.compose_project }}-worker
    volumes:
      - ./backend:/app
      - ./pipeline:/pipeline:ro
      - {{ settings.shared_model_cache_volume }}:/data/models/cache:ro

  db:
    container_name: {{ worktree.compose_project }}-db
    ports:
      - "127.0.0.1:{{ worktree.ports.db }}:5432"
    volumes:
      - {{ worktree.volumes.postgres }}:/var/lib/postgresql/data

  redis:
    container_name: {{ worktree.compose_project }}-redis
    ports:
      - "127.0.0.1:{{ worktree.ports.redis }}:6379"
    volumes:
      - {{ worktree.volumes.redis }}:/data

  cloudbeaver:
    container_name: {{ worktree.compose_project }}-cloudbeaver
    ports:
      - "127.0.0.1:{{ worktree.ports.cloudbeaver }}:8978"
    volumes:
      - {{ worktree.volumes.cloudbeaver }}:/opt/cloudbeaver/workspace
    environment:
      CB_SERVER_NAME: "GTS {{ worktree.worktree_name }}"

volumes:
  {{ worktree.volumes.postgres }}:
  {{ worktree.volumes.redis }}:
  {{ worktree.volumes.uploads }}:
  {{ worktree.volumes.cloudbeaver }}:
  {{ settings.shared_model_cache_volume }}:
    external: true
